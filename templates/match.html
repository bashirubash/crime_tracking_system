{% extends "base.html" %}
{% block content %}
<div class="container mt-5 text-center">
  <div class="card shadow p-5">
    <h3>Fingerprint Matching</h3>
    <p class="text-muted">Click below to scan fingerprint and match against database.</p>
    
    <button class="btn btn-lg btn-primary" onclick="scanFingerprint()">Scan Fingerprint</button>
    
    <div id="fp-status" class="mt-3 text-muted">No fingerprint scanned yet</div>
  </div>
</div>

<!-- DigitalPersona Web SDK -->
<script src="https://cdn.digitalpersona.com/dp-web-sdk/2.0.0/dp-web-sdk.min.js"></script>
<script>
  const reader = new FingerprintReader();

  async function scanFingerprint() {
    try {
      await reader.startAcquisition(Fingerprint.SampleFormat.PngImage);
      document.getElementById("fp-status").innerText = "Place your finger on the scanner...";

      reader.onSamplesAcquired = async function (event) {
        const samples = JSON.parse(event.samples);
        if (samples.length > 0) {
          const fingerprintData = samples[0]; // Base64 image/string
          document.getElementById("fp-status").innerText = "✅ Fingerprint captured! Checking database...";

          // Stop further scans
          await reader.stopAcquisition();

          // Send to backend for matching
          fetch("/match_fingerprint", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token() }}"   // if Django/Flask-WTF is used
            },
            body: JSON.stringify({ fingerprint: fingerprintData })
          })
          .then(res => res.json())
          .then(data => {
            if (data.match) {
              document.getElementById("fp-status").innerText = "✅ Match found: " + data.name;
            } else {
              document.getElementById("fp-status").innerText = "❌ No match found.";
            }
          })
          .catch(err => {
            document.getElementById("fp-status").innerText = "⚠️ Error sending fingerprint: " + err;
          });
        }
      };
    } catch (err) {
      document.getElementById("fp-status").innerText = "⚠️ Fingerprint reader error: " + err.message;
    }
  }
</script>
{% endblock %}
