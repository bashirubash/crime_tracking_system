{% extends "base.html" %}
{% block content %}
<div class="container mt-5 text-center">
  <div class="card shadow p-5">
    <h3>Fingerprint Matching</h3>
    <p class="text-muted">Click below to scan fingerprint and match against database.</p>
    
    <button class="btn btn-lg btn-primary" onclick="scanFingerprint()">Scan Fingerprint</button>
    
    <div id="fp-status" class="mt-3 text-muted">No fingerprint scanned yet</div>
  </div>
</div>

<!-- DigitalPersona Web SDK -->
<script src="https://cdn.digitalpersona.com/dp-web-sdk/2.0.0/dp-web-sdk.min.js"></script>
<script>
  let reader;

  async function scanFingerprint() {
    document.getElementById("fp-status").innerText = "üîÑ Trying hardware scanner...";

    try {
      // -------- Try backend /scan first --------
      const res = await fetch("/scan");
      const data = await res.json();

      if (data.status === "success" && data.fingerprint) {
        document.getElementById("fp-status").innerText = "‚úÖ Fingerprint captured from hardware! Checking database...";

        // send to backend for matching
        matchFingerprint(data.fingerprint);
        return;
      } else {
        document.getElementById("fp-status").innerText = "‚ö†Ô∏è Hardware scan failed (" + data.message + "). Falling back to Web SDK...";
        fallbackWebSDK();
      }
    } catch (err) {
      document.getElementById("fp-status").innerText = "‚ö†Ô∏è Error using hardware scanner: " + err + ". Falling back to Web SDK...";
      fallbackWebSDK();
    }
  }

  // --------- Web SDK fallback ----------
  async function fallbackWebSDK() {
    try {
      reader = new FingerprintReader();
      await reader.startAcquisition(Fingerprint.SampleFormat.PngImage);

      document.getElementById("fp-status").innerText = "Place your finger on the scanner (Web SDK)...";

      reader.onSamplesAcquired = async function (event) {
        const samples = JSON.parse(event.samples);
        if (samples.length > 0) {
          const fingerprintData = samples[0]; 
          document.getElementById("fp-status").innerText = "‚úÖ Fingerprint captured (Web SDK)! Checking database...";

          await reader.stopAcquisition();
          matchFingerprint(fingerprintData);
        }
      };
    } catch (err) {
      document.getElementById("fp-status").innerText = "‚ö†Ô∏è Web SDK error: " + err.message;
    }
  }

  // --------- Send to backend for DB match ----------
  function matchFingerprint(fingerprintData) {
    fetch("/match_fingerprint", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fingerprint: fingerprintData })
    })
    .then(res => res.json())
    .then(data => {
      if (data.match) {
        document.getElementById("fp-status").innerText = "‚úÖ Match found: " + data.name;
      } else {
        document.getElementById("fp-status").innerText = "‚ùå No match found.";
      }
    })
    .catch(err => {
      document.getElementById("fp-status").innerText = "‚ö†Ô∏è Error sending fingerprint: " + err;
    });
  }
</script>
{% endblock %}
