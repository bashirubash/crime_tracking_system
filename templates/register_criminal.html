{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow p-4">
    <h3 class="mb-4">Register Criminal</h3>
    <form method="POST" id="criminalForm" onsubmit="return validateForm()">
      <div class="row mb-3">
        <div class="col">
          <label class="form-label">Full Name</label>
          <input type="text" name="name" class="form-control" required>
        </div>
        <div class="col">
          <label class="form-label">Age</label>
          <input type="number" name="age" class="form-control" required>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Gender</label>
        <select name="gender" class="form-select" required>
          <option value="">-- Select --</option>
          <option>Male</option>
          <option>Female</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Fingerprint</label><br>
        <button type="button" class="btn btn-outline-primary" onclick="captureFingerprint()">Capture Fingerprint</button>
        <input type="hidden" name="fingerprint" id="fingerprintInput">
        <small id="fp-status" class="text-muted d-block mt-2">No fingerprint captured yet</small>
      </div>

      <button class="btn btn-success w-100">Register</button>
    </form>
  </div>
</div>

<!-- DigitalPersona Web SDK -->
<script src="https://cdn.digitalpersona.com/dp-web-sdk/2.0.0/dp-web-sdk.min.js"></script>
<script>
  let reader;

  // Main capture handler
  async function captureFingerprint() {
    document.getElementById("fp-status").innerText = "üîÑ Trying hardware scanner...";

    try {
      // -------- Try backend /scan first --------
      const res = await fetch("/scan");
      const data = await res.json();

      if (data.status === "success" && data.fingerprint) {
        document.getElementById("fingerprintInput").value = data.fingerprint;
        document.getElementById("fp-status").innerText = "‚úÖ Fingerprint captured from hardware!";
        return;
      } else {
        document.getElementById("fp-status").innerText = "‚ö†Ô∏è Hardware scan failed (" + data.message + "). Falling back to Web SDK...";
        fallbackWebSDK();
      }
    } catch (err) {
      document.getElementById("fp-status").innerText = "‚ö†Ô∏è Error using hardware scanner: " + err + ". Falling back to Web SDK...";
      fallbackWebSDK();
    }
  }

  // --------- Web SDK fallback ----------
  async function fallbackWebSDK() {
    try {
      reader = new FingerprintReader();
      await reader.startAcquisition(Fingerprint.SampleFormat.PngImage);

      document.getElementById("fp-status").innerText = "Place your finger on the scanner (Web SDK)...";

      reader.onSamplesAcquired = function (event) {
        const samples = JSON.parse(event.samples);
        if (samples.length > 0) {
          document.getElementById("fingerprintInput").value = samples[0];
          document.getElementById("fp-status").innerText = "‚úÖ Fingerprint captured (Web SDK)!";
          reader.stopAcquisition();
        }
      };
    } catch (err) {
      document.getElementById("fp-status").innerText = "‚ö†Ô∏è Web SDK error: " + err.message;
    }
  }

  // --------- Validate before submit ----------
  function validateForm() {
    const fp = document.getElementById("fingerprintInput").value;
    if (!fp) {
      alert("Please capture fingerprint before submitting.");
      return false;
    }
    return true;
  }
</script>
{% endblock %}
