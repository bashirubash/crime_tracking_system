{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow p-4">
    <h3 class="mb-4">Register Criminal</h3>
    <form method="POST" id="criminalForm" onsubmit="return validateForm()">
      <div class="row mb-3">
        <div class="col">
          <label class="form-label">Full Name</label>
          <input type="text" name="name" class="form-control" required>
        </div>
        <div class="col">
          <label class="form-label">Age</label>
          <input type="number" name="age" class="form-control" required>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Gender</label>
        <select name="gender" class="form-select" required>
          <option value="">-- Select --</option>
          <option>Male</option>
          <option>Female</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Fingerprint</label><br>
        <button type="button" class="btn btn-outline-primary" onclick="captureFingerprint()">Capture Fingerprint</button>
        <input type="hidden" name="fingerprint" id="fingerprintInput">
        <small id="fp-status" class="text-muted d-block mt-2">No fingerprint captured yet</small>
      </div>

      <button class="btn btn-success w-100">Register</button>
    </form>
  </div>
</div>

<!-- DigitalPersona Web SDK -->
<script src="https://cdn.digitalpersona.com/dp-web-sdk/2.0.0/dp-web-sdk.min.js"></script>
<script>
  let reader;

  window.onload = function() {
    try {
      reader = new FingerprintReader();
    } catch (err) {
      document.getElementById("fp-status").innerText = "⚠️ Fingerprint reader not available.";
    }
  };

  async function captureFingerprint() {
    if (!reader) {
      document.getElementById("fp-status").innerText = "⚠️ Reader not initialized.";
      return;
    }

    try {
      // Always stop any ongoing acquisition before starting
      await reader.stopAcquisition().catch(()=>{});

      await reader.startAcquisition(Fingerprint.SampleFormat.PngImage);
      document.getElementById("fp-status").innerText = "Place your finger on the scanner...";

      reader.onSamplesAcquired = function (event) {
        const samples = JSON.parse(event.samples);
        if (samples.length > 0) {
          document.getElementById("fingerprintInput").value = samples[0];
          document.getElementById("fp-status").innerText = "✅ Fingerprint captured!";
          reader.stopAcquisition();
        }
      };
    } catch (err) {
      document.getElementById("fp-status").innerText = "⚠️ Error: " + err.message;
    }
  }

  function validateForm() {
    const fp = document.getElementById("fingerprintInput").value;
    if (!fp) {
      alert("Please capture fingerprint before submitting.");
      return false;
    }
    return true;
  }
</script>
{% endblock %}
